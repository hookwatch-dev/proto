syntax = "proto3";

package hookwatch.cron.v1;

option go_package = "github.com/hookwatch-dev/proto/cron/v1;cronv1";

import "google/protobuf/timestamp.proto";

// CronService handles cron job management and execution coordination between CLI and core.
service CronService {
  // === Execution coordination (existing) ===

  // GetPendingExecutions returns executions waiting to be picked up by a CLI agent.
  rpc GetPendingExecutions(GetPendingExecutionsRequest) returns (GetPendingExecutionsResponse);

  // ClaimExecution marks an execution as running (claimed by a CLI agent).
  rpc ClaimExecution(ClaimExecutionRequest) returns (ClaimExecutionResponse);

  // UpdateExecution updates an execution with the result after local execution.
  rpc UpdateExecution(UpdateExecutionRequest) returns (UpdateExecutionResponse);

  // GetJobCommand returns the command details for a job so the CLI can execute it.
  rpc GetJobCommand(GetJobCommandRequest) returns (GetJobCommandResponse);

  // === Job CRUD ===

  // ListCronJobs returns all cron jobs for the authenticated user.
  rpc ListCronJobs(ListCronJobsRequest) returns (ListCronJobsResponse);

  // GetCronJob returns a single cron job by ID.
  rpc GetCronJob(GetCronJobRequest) returns (GetCronJobResponse);

  // CreateCronJob creates a new cron job.
  rpc CreateCronJob(CreateCronJobRequest) returns (CreateCronJobResponse);

  // UpdateCronJob updates an existing cron job.
  rpc UpdateCronJob(UpdateCronJobRequest) returns (UpdateCronJobResponse);

  // DeleteCronJob deletes a cron job.
  rpc DeleteCronJob(DeleteCronJobRequest) returns (DeleteCronJobResponse);

  // EnableCronJob enables a cron job.
  rpc EnableCronJob(EnableCronJobRequest) returns (EnableCronJobResponse);

  // DisableCronJob disables a cron job.
  rpc DisableCronJob(DisableCronJobRequest) returns (DisableCronJobResponse);

  // RunCronJob triggers a manual execution of a cron job.
  rpc RunCronJob(RunCronJobRequest) returns (RunCronJobResponse);

  // GetNextCronRuns returns the next scheduled runs for enabled jobs.
  rpc GetNextCronRuns(GetNextCronRunsRequest) returns (GetNextCronRunsResponse);

  // === Execution queries ===

  // ListCronExecutions returns executions with optional filters.
  rpc ListCronExecutions(ListCronExecutionsRequest) returns (ListCronExecutionsResponse);

  // GetCronExecution returns a single execution by ID.
  rpc GetCronExecution(GetCronExecutionRequest) returns (GetCronExecutionResponse);

  // RetryCronExecution creates a retry of a previous execution.
  rpc RetryCronExecution(RetryCronExecutionRequest) returns (RetryCronExecutionResponse);

  // ReportCronExecution reports a local execution result to the cloud.
  rpc ReportCronExecution(ReportCronExecutionRequest) returns (ReportCronExecutionResponse);
}

// === Shared messages ===

// CronRetryConfig defines retry configuration for cron jobs.
message CronRetryConfig {
  int32 max_retries = 1;
  repeated int32 intervals = 2;
}

// CronNotificationConfig defines notification settings for cron jobs.
message CronNotificationConfig {
  bool on_failure = 1;
  bool on_success = 2;
}

// CronJob represents a full cron job.
message CronJob {
  string id = 1;
  string name = 2;
  string schedule = 3;
  string schedule_cron = 4;
  string command = 5;
  string working_dir = 6;
  int32 timeout_seconds = 7;
  bool is_enabled = 8;
  CronRetryConfig retry_config = 9;
  CronNotificationConfig notification_config = 10;
  map<string, string> environment = 11;
  repeated string tags = 12;
  google.protobuf.Timestamp last_run_at = 13;
  google.protobuf.Timestamp next_run_at = 14;
  google.protobuf.Timestamp created_at = 15;
  google.protobuf.Timestamp updated_at = 16;
}

// CronExecution represents a single execution of a cron job.
message CronExecution {
  string id = 1;
  string job_id = 2;
  string status = 3;
  int32 exit_code = 4;
  bool has_exit_code = 5;
  string stdout = 6;
  string stderr = 7;
  int32 duration_ms = 8;
  bool has_duration_ms = 9;
  int32 retry_count = 10;
  string triggered_by = 11;
  string host_name = 12;
  google.protobuf.Timestamp started_at = 13;
  google.protobuf.Timestamp completed_at = 14;
}

// === Execution coordination messages (existing) ===

// GetPendingExecutionsRequest requests pending executions for the authenticated user.
message GetPendingExecutionsRequest {
  // API key for authentication
  string api_key = 1;
}

// PendingExecution represents a single pending execution to be picked up.
message PendingExecution {
  string execution_id = 1;
  string job_id = 2;
  string job_name = 3;
  int32 retry_count = 4;
  string triggered_by = 5;
  google.protobuf.Timestamp created_at = 6;
}

// GetPendingExecutionsResponse returns the list of pending executions.
message GetPendingExecutionsResponse {
  repeated PendingExecution executions = 1;
}

// ClaimExecutionRequest marks an execution as being processed by a CLI agent.
message ClaimExecutionRequest {
  string api_key = 1;
  string execution_id = 2;
  string host_name = 3;
}

// ClaimExecutionResponse confirms the claim.
message ClaimExecutionResponse {
  bool success = 1;
  string error = 2;
  // Job details needed for execution
  string command = 3;
  string working_dir = 4;
  map<string, string> environment = 5;
  int32 timeout_seconds = 6;
}

// UpdateExecutionRequest updates an execution with the result.
message UpdateExecutionRequest {
  string api_key = 1;
  string execution_id = 2;
  string status = 3; // success, failed, timeout, canceled
  int32 exit_code = 4;
  string stdout = 5;
  string stderr = 6;
  int32 duration_ms = 7;
  google.protobuf.Timestamp completed_at = 8;
}

// UpdateExecutionResponse confirms the update.
message UpdateExecutionResponse {
  bool success = 1;
  string error = 2;
}

// GetJobCommandRequest requests command details for a job.
message GetJobCommandRequest {
  string api_key = 1;
  string job_id = 2;
}

// GetJobCommandResponse returns command details.
message GetJobCommandResponse {
  string command = 1;
  string working_dir = 2;
  map<string, string> environment = 3;
  int32 timeout_seconds = 4;
}

// === Job CRUD messages ===

message ListCronJobsRequest {
  string api_key = 1;
}

message ListCronJobsResponse {
  repeated CronJob jobs = 1;
}

message GetCronJobRequest {
  string api_key = 1;
  string id = 2;
}

message GetCronJobResponse {
  CronJob job = 1;
}

message CreateCronJobRequest {
  string api_key = 1;
  string name = 2;
  string schedule = 3;
  string schedule_cron = 4;
  string command = 5;
  string working_dir = 6;
  int32 timeout_seconds = 7;
  CronRetryConfig retry_config = 8;
  CronNotificationConfig notification_config = 9;
  map<string, string> environment = 10;
  repeated string tags = 11;
}

message CreateCronJobResponse {
  CronJob job = 1;
}

message UpdateCronJobRequest {
  string api_key = 1;
  string id = 2;
  string name = 3;
  string schedule = 4;
  string schedule_cron = 5;
  string command = 6;
  string working_dir = 7;
  int32 timeout_seconds = 8;
  bool is_enabled = 9;
  CronRetryConfig retry_config = 10;
  CronNotificationConfig notification_config = 11;
  map<string, string> environment = 12;
  repeated string tags = 13;
}

message UpdateCronJobResponse {
  CronJob job = 1;
}

message DeleteCronJobRequest {
  string api_key = 1;
  string id = 2;
}

message DeleteCronJobResponse {}

message EnableCronJobRequest {
  string api_key = 1;
  string id = 2;
}

message EnableCronJobResponse {
  CronJob job = 1;
}

message DisableCronJobRequest {
  string api_key = 1;
  string id = 2;
}

message DisableCronJobResponse {
  CronJob job = 1;
}

message RunCronJobRequest {
  string api_key = 1;
  string id = 2;
}

message RunCronJobResponse {
  CronExecution execution = 1;
}

message GetNextCronRunsRequest {
  string api_key = 1;
  int32 count = 2;
}

message GetNextCronRunsResponse {
  repeated CronJob jobs = 1;
}

// === Execution query messages ===

message ListCronExecutionsRequest {
  string api_key = 1;
  string job_id = 2;
  string status = 3;
  int32 limit = 4;
  int32 offset = 5;
}

message ListCronExecutionsResponse {
  repeated CronExecution executions = 1;
}

message GetCronExecutionRequest {
  string api_key = 1;
  string id = 2;
}

message GetCronExecutionResponse {
  CronExecution execution = 1;
}

message RetryCronExecutionRequest {
  string api_key = 1;
  string id = 2;
}

message RetryCronExecutionResponse {
  CronExecution execution = 1;
}

message ReportCronExecutionRequest {
  string api_key = 1;
  string job_id = 2;
  string status = 3;
  int32 exit_code = 4;
  bool has_exit_code = 5;
  string stdout = 6;
  string stderr = 7;
  int32 duration_ms = 8;
  bool has_duration_ms = 9;
  int32 retry_count = 10;
  string triggered_by = 11;
  string host_name = 12;
  google.protobuf.Timestamp started_at = 13;
  google.protobuf.Timestamp completed_at = 14;
}

message ReportCronExecutionResponse {
  CronExecution execution = 1;
}
